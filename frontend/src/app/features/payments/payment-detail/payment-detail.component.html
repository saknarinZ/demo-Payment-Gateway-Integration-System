<div class="max-w-5xl mx-auto">
  <!-- Back Button -->
  <div class="mb-4">
    <a
      routerLink="/payments"
      class="text-blue-600 hover:text-blue-700 font-medium"
      >‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Payment</a
    >
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="flex flex-col items-center justify-center py-12">
    <div
      class="w-10 h-10 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"
    ></div>
    <p class="mt-4 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
    <p class="text-red-700 mb-4">‚ùå {{ error() }}</p>
    <button
      class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
      (click)="loadPayment()"
    >
      ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    </button>
  </div>
  }

  <!-- Payment Detail -->
  @if (payment(); as p) {
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Main Info Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div
        class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"
      >
        <h1 class="text-lg font-bold text-gray-900">{{ p.referenceId }}</h1>
        <span
          class="px-3 py-1 text-sm font-medium rounded-full"
          [class]="
            p.status === 'COMPLETED'
              ? 'bg-green-100 text-green-700'
              : p.status === 'PENDING'
              ? 'bg-yellow-100 text-yellow-700'
              : p.status === 'FAILED'
              ? 'bg-red-100 text-red-700'
              : p.status === 'CANCELLED'
              ? 'bg-gray-100 text-gray-700'
              : p.status === 'REFUNDED'
              ? 'bg-purple-100 text-purple-700'
              : 'bg-gray-100 text-gray-700'
          "
        >
          {{ getStatusLabel(p.status) }}
        </span>
      </div>

      <div class="p-6 space-y-4">
        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
          <span class="text-2xl font-bold text-blue-600">
            {{ formatAmount(p.amount, p.currency) }}
          </span>
        </div>

        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
          <span class="font-medium text-gray-900">
            {{ getPaymentMethodLabel(p.paymentMethod) }}
          </span>
        </div>

        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
          <span class="text-gray-700">{{ formatDate(p.createdAt) }}</span>
        </div>

        @if (p.completedAt) {
        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
          <span class="text-gray-700">{{ formatDate(p.completedAt) }}</span>
        </div>
        }
      </div>
    </div>

    <!-- Customer Info Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100">
        <h2 class="font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
      </div>

      <div class="p-6 space-y-4">
        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
          <span class="font-medium text-gray-900">{{ p.customerName }}</span>
        </div>

        <div
          class="flex justify-between items-center py-2 border-b border-gray-100"
        >
          <span class="text-gray-500 text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</span>
          <span class="text-gray-700">{{ p.customerEmail }}</span>
        </div>

        @if (p.description) {
        <div class="py-2">
          <span class="text-gray-500 text-sm block mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
          <span class="text-gray-700">{{ p.description }}</span>
        </div>
        }
      </div>
    </div>

    <!-- Actions Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100">
        <h2 class="font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
      </div>

      <div class="p-6">
        <!-- Payment Link Section (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PENDING) -->
        @if (p.status === 'PENDING') {
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 mb-3">
            üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </h3>
          <div class="flex gap-2">
            <input
              type="text"
              readonly
              [value]="paymentLink()"
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
            />
            <button
              class="px-4 py-2 border border-gray-300 rounded-lg font-medium transition-colors"
              [class]="
                linkCopied()
                  ? 'bg-green-50 border-green-300 text-green-700'
                  : 'bg-white hover:bg-gray-50'
              "
              (click)="copyPaymentLink()"
            >
              @if (linkCopied()) { ‚úì ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß } @else { üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å }
            </button>
          </div>
          <div class="mt-3">
            <button
              class="px-4 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition-colors"
              (click)="openCheckout()"
            >
              üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
          </div>
          <p class="text-sm text-gray-500 mt-3">
            üí° ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </p>
        </div>
        } @switch (p.status) { @case ('PENDING') {
        <div class="space-y-3">
          <button
            class="w-full px-4 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors disabled:opacity-50"
            (click)="completePayment()"
            [disabled]="actionLoading()"
          >
            ‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </button>
          <button
            class="w-full px-4 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors disabled:opacity-50"
            (click)="cancelPayment()"
            [disabled]="actionLoading()"
          >
            ‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </button>
        </div>
        } @case ('COMPLETED') {
        <div class="space-y-4">
          <button
            class="w-full px-4 py-3 bg-yellow-500 text-white rounded-lg font-medium hover:bg-yellow-600 transition-colors disabled:opacity-50"
            (click)="showRefundForm.set(true)"
            [disabled]="actionLoading() || showRefundForm()"
          >
            ‚Ü© ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Refund)
          </button>
        </div>

        @if (showRefundForm()) {
        <div class="mt-4 p-4 bg-gray-50 rounded-lg space-y-4">
          <h3 class="font-medium text-gray-900">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h3>
          <div class="space-y-1">
            <label class="text-sm text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</label>
            <input
              type="number"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              [value]="refundAmount()"
              (input)="onRefundAmountChange($event)"
              [max]="p.amount"
              min="0.01"
              step="0.01"
            />
            <small class="text-gray-500 text-sm"
              >‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: {{ formatAmount(p.amount, p.currency) }}</small
            >
          </div>
          <div class="space-y-1">
            <label class="text-sm text-gray-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
            <textarea
              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
              rows="3"
              [value]="refundReason()"
              (input)="onRefundReasonChange($event)"
              placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."
            ></textarea>
          </div>
          <div class="flex gap-3">
            <button
              class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg font-medium hover:bg-yellow-600 transition-colors disabled:opacity-50"
              (click)="processRefund()"
              [disabled]="actionLoading() || !isRefundValid()"
            >
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            <button
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition-colors"
              (click)="showRefundForm.set(false)"
            >
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
          </div>
        </div>
        } } @case ('CANCELLED') {
        <div class="p-4 bg-gray-50 rounded-lg text-center text-gray-600">
          <p>‚ùå Payment ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
        } @case ('REFUNDED') {
        <div class="p-4 bg-purple-50 rounded-lg text-center text-purple-700">
          <p>‚Ü© Payment ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
        } @case ('FAILED') {
        <div class="p-4 bg-red-50 rounded-lg text-center text-red-700">
          <p>‚ö†Ô∏è Payment ‡∏ô‡∏µ‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>
        </div>
        } @default {
        <div class="p-4 bg-gray-50 rounded-lg text-center text-gray-600">
          <p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</p>
        </div>
        } }
      </div>
    </div>

    <!-- Transactions Card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100">
        <h2 class="font-semibold text-gray-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Transactions</h2>
      </div>

      <div class="p-6">
        @if (p.transactions && p.transactions.length > 0) {
        <div class="space-y-3">
          @for (tx of p.transactions; track tx.transactionId) {
          <div class="p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span
                class="px-2 py-1 text-xs font-medium rounded"
                [class]="
                  tx.type === 'CHARGE'
                    ? 'bg-blue-100 text-blue-700'
                    : tx.type === 'REFUND'
                    ? 'bg-purple-100 text-purple-700'
                    : 'bg-gray-100 text-gray-700'
                "
              >
                {{ getTransactionTypeLabel(tx.type) }}
              </span>
              <span
                class="px-2 py-1 text-xs font-medium rounded"
                [class]="
                  tx.status === 'SUCCESS'
                    ? 'bg-green-100 text-green-700'
                    : tx.status === 'PENDING'
                    ? 'bg-yellow-100 text-yellow-700'
                    : 'bg-red-100 text-red-700'
                "
              >
                {{ tx.status }}
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">{{ tx.transactionId }}</span>
              <span class="font-semibold text-gray-900">
                {{ formatAmount(tx.amount, p.currency) }}
              </span>
            </div>
            <div class="text-xs text-gray-500 mt-2">
              {{ formatDate(tx.createdAt) }}
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="text-center py-8 text-gray-500">
          <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Transaction</p>
        </div>
        }
      </div>
    </div>
  </div>
  }
</div>
